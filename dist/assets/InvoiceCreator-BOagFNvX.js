import{j as e,e as E,f as P,g as T,h as k,B as w,k as ie,w as re,r as F,P as ce,R as le,b as oe,z as de,A as he,i as me,d as ue,K as R,E as pe,H as xe,m as ge}from"./index-BCVF1PLb.js";import{L as I}from"./label-gCXM_mwv.js";import{I as y}from"./input-CMYn3E83.js";import{S as O,a as q,b as B,c as V,d as b}from"./select-B5ckg96L.js";import{T as je}from"./trash-2-Doau15tD.js";import{P as ve}from"./plus-circle-CsZ-giTn.js";import{S as fe}from"./save-BLsd0mx1.js";import{D as Ne}from"./download-DKg7zGZ5.js";import{S as Se}from"./send-DnfGf0z0.js";import{g as be}from"./pdf-DOpULH4B.js";import{A as ye}from"./arrow-left-BVjyKR_C.js";import"./floating-ui.react-dom-DMRTrF13.js";import"./check-C26bXOMj.js";import"./jspdf.es.min-BgNKXESA.js";import"./de-B2K29ify.js";const we=({invoice:a,setInvoice:i,coachees:r})=>{const x=(s,c)=>{i(v=>({...v,[s]:c}))},g=(s,c)=>{const v=s==="coacheeId"&&c!=="placeholder"?parseInt(c,10):c;x(s,v)};return e.jsxs(E,{className:"glass-card",children:[e.jsx(P,{children:e.jsx(T,{children:"Rechnungsdetails"})}),e.jsxs(k,{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"coachee",children:"Coachee"}),e.jsxs(O,{value:a.coacheeId.toString(),onValueChange:s=>g("coacheeId",s),children:[e.jsx(q,{id:"coachee",children:e.jsx(B,{placeholder:"Coachee auswählen..."})}),e.jsxs(V,{children:[e.jsx(b,{value:"placeholder",disabled:!0,children:"Bitte wählen..."}),r.map(s=>e.jsxs(b,{value:s.id.toString(),children:[s.firstName," ",s.lastName]},s.id))]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"invoice-number",children:"Rechnungsnummer"}),e.jsx(y,{id:"invoice-number",value:a.invoiceNumber,onChange:s=>x("invoiceNumber",s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"invoice-date",children:"Rechnungsdatum"}),e.jsx(y,{id:"invoice-date",type:"date",value:a.date,onChange:s=>x("date",s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"due-date",children:"Zahlungsfrist"}),e.jsx(y,{id:"due-date",type:"date",value:a.dueDate,onChange:s=>x("dueDate",s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"tax-rate",children:"Steuersatz (%)"}),e.jsx(y,{id:"tax-rate",type:"number",value:a.taxRate,onChange:s=>x("taxRate",s.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(I,{htmlFor:"currency",children:"Währung"}),e.jsxs(O,{value:a.currency,onValueChange:s=>g("currency",s),children:[e.jsx(q,{id:"currency",children:e.jsx(B,{})}),e.jsxs(V,{children:[e.jsx(b,{value:"EUR",children:"EUR (€)"}),e.jsx(b,{value:"USD",children:"USD ($)"}),e.jsx(b,{value:"CHF",children:"CHF"})]})]})]})]})]})},Ie=({items:a,setItems:i,serviceRates:r,currency:x})=>{const g=(l,m,n)=>{const u=[...a];u[l][m]=n,i(u)},s=(l,m)=>{const n=r.find(u=>u.id.toString()===m);if(n){const u=[...a];u[l].description=n.name,u[l].price=n.price,u[l].rateId=n.id,u[l].isCustom=!1,i(u)}},c=()=>{i([...a,{id:Date.now(),description:"",quantity:1,price:0,isCustom:!0}])},v=l=>{const m=a.filter((n,u)=>u!==l);i(m)};return e.jsxs(E,{className:"glass-card",children:[e.jsx(P,{children:e.jsx(T,{children:"Rechnungspositionen"})}),e.jsxs(k,{children:[e.jsx("div",{className:"space-y-4",children:a.map((l,m)=>e.jsxs("div",{className:"grid grid-cols-12 gap-2 items-center p-2 rounded-md bg-slate-800/50",children:[e.jsxs("div",{className:"col-span-12 md:col-span-5",children:[e.jsxs(O,{onValueChange:n=>s(m,n),children:[e.jsx(q,{children:e.jsx(B,{placeholder:"Honorarsatz wählen oder manuell eingeben..."})}),e.jsxs(V,{children:[e.jsx(b,{value:"placeholder",disabled:!0,children:"Honorarsatz wählen..."}),(r||[]).map(n=>e.jsxs(b,{value:String(n.id),children:[n.name," (€",n.price.toFixed(2),")"]},n.id))]})]}),e.jsx(y,{type:"text",placeholder:"Beschreibung",value:l.description,onChange:n=>g(m,"description",n.target.value),className:"mt-1",disabled:!l.isCustom})]}),e.jsx("div",{className:"col-span-4 md:col-span-2",children:e.jsx(y,{type:"number",placeholder:"Menge",value:l.quantity,onChange:n=>g(m,"quantity",parseFloat(n.target.value))})}),e.jsx("div",{className:"col-span-4 md:col-span-2",children:e.jsx(y,{type:"number",placeholder:"Preis",value:l.price,onChange:n=>g(m,"price",parseFloat(n.target.value)),disabled:!l.isCustom})}),e.jsxs("div",{className:"col-span-3 md:col-span-2 text-right font-semibold",children:[((l.quantity||0)*(l.price||0)).toFixed(2)," ",x]}),e.jsx("div",{className:"col-span-1 text-right",children:e.jsx(w,{variant:"ghost",size:"icon",onClick:()=>v(m),children:e.jsx(je,{className:"h-4 w-4 text-red-500"})})})]},l.id))}),e.jsxs(w,{onClick:c,variant:"outline",className:"mt-4",children:[e.jsx(ie,{className:"mr-2 h-4 w-4"})," Position hinzufügen"]})]})]})},Ce=({sessions:a,onAddSession:i})=>a.length===0?null:e.jsxs(E,{className:"glass-card",children:[e.jsxs(P,{children:[e.jsx(T,{children:"Unabgerechnete Sessions"}),e.jsx(re,{children:"Füge abgeschlossene, aber noch nicht abgerechnete Sessions zur Rechnung hinzu."})]}),e.jsx(k,{children:e.jsx("ul",{className:"space-y-2",children:a.map(r=>e.jsxs("li",{className:"flex justify-between items-center p-2 bg-slate-800/50 rounded-md",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:r.topic}),e.jsx("p",{className:"text-sm text-slate-400",children:new Date(r.date).toLocaleDateString("de-DE")})]}),e.jsxs(w,{variant:"ghost",size:"sm",onClick:()=>i(r.id),children:[e.jsx(ve,{className:"mr-2 h-4 w-4"})," Hinzufügen"]})]},r.id))})})]});var De="Separator",G="horizontal",Re=["horizontal","vertical"],M=F.forwardRef((a,i)=>{const{decorative:r,orientation:x=G,...g}=a,s=Fe(x)?x:G,v=r?{role:"none"}:{"aria-orientation":s==="vertical"?s:void 0,role:"separator"};return e.jsx(ce.div,{"data-orientation":s,...v,...g,ref:i})});M.displayName=De;function Fe(a){return Re.includes(a)}var K=M;const Y=le.forwardRef(({className:a,orientation:i="horizontal",decorative:r=!0,...x},g)=>e.jsx(K,{ref:g,decorative:r,orientation:i,className:oe("shrink-0 bg-border",i==="horizontal"?"h-[1px] w-full":"h-full w-[1px]",a),...x}));Y.displayName=K.displayName;const Ae=({items:a,taxRate:i,currency:r,onSaveDraft:x,onSaveAndDownload:g,onSaveAndSend:s})=>{const c=a.reduce((n,u)=>n+(u.quantity||0)*(u.price||0),0),v=c*(parseFloat(i)/100),l=c+v,m=n=>({EUR:"€",USD:"$",CHF:"CHF"})[n]||n;return e.jsxs(E,{className:"glass-card sticky top-8",children:[e.jsx(P,{children:e.jsx(T,{children:"Zusammenfassung & Aktionen"})}),e.jsxs(k,{children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-slate-400",children:"Zwischensumme"}),e.jsxs("span",{className:"font-semibold",children:[c.toFixed(2)," ",m(r)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("span",{className:"text-slate-400",children:["Steuer (",i,"%)"]}),e.jsxs("span",{className:"font-semibold",children:[v.toFixed(2)," ",m(r)]})]}),e.jsx(Y,{className:"bg-slate-700"}),e.jsxs("div",{className:"flex justify-between text-lg font-bold text-primary",children:[e.jsx("span",{children:"Gesamtbetrag"}),e.jsxs("span",{children:[l.toFixed(2)," ",m(r)]})]})]}),e.jsx(Y,{className:"my-6 bg-slate-700"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs(w,{onClick:x,className:"w-full",variant:"secondary",children:[e.jsx(fe,{className:"mr-2 h-4 w-4"})," Als Entwurf speichern"]}),e.jsxs(w,{onClick:g,className:"w-full",children:[e.jsx(Ne,{className:"mr-2 h-4 w-4"})," Speichern & Herunterladen"]}),e.jsxs(w,{onClick:s,className:"w-full",variant:"outline",children:[e.jsx(Se,{className:"mr-2 h-4 w-4"})," Speichern & Senden"]})]})]})]})},Ee=({onClose:a,isNew:i})=>e.jsx("div",{className:"flex justify-between items-start mb-6 pb-4 border-b border-slate-700",children:e.jsxs("div",{children:[e.jsxs(w,{variant:"ghost",onClick:a,className:"mb-2 -ml-4",children:[e.jsx(ye,{className:"mr-2 h-4 w-4"})," Zurück zu den Rechnungen"]}),e.jsx("h1",{className:"text-3xl font-bold text-white",children:i?"Neue Rechnung":"Rechnung bearbeiten"}),e.jsx("p",{className:"text-slate-400",children:"Erstelle und verwalte eine neue Rechnung für deine Coachees."})]})}),Ge=()=>{const{id:a}=de(),i=he(),{toast:r}=me(),{state:x,actions:g}=ue(),{isLoading:s,settings:c,coachees:v,sessions:l,serviceRates:m,invoices:n}=x,{setInvoices:u,setSessions:W}=g,A=!a,[t,C]=F.useState(null);F.useEffect(()=>{var o,h,f;if(!s)if(A){const N=()=>{if(!n||n.length===0)return`CS-${new Date().getFullYear()}-001`;const p=n.sort((ae,te)=>te.invoiceNumber.localeCompare(ae.invoiceNumber))[0].invoiceNumber;if(!p||typeof p!="string"||!p.includes("-"))return`CS-${new Date().getFullYear()}-001`;const D=p.split("-"),U=D[1],_=D[D.length-1],L=new Date().getFullYear().toString();if(U!==L)return`CS-${L}-001`;const ne=parseInt(_,10)+1;return`CS-${L}-${String(ne).padStart(_.length,"0")}`},d=((o=c==null?void 0:c.company)==null?void 0:o.paymentDeadlineDays)||14,j=new Date;j.setDate(j.getDate()+parseInt(d,10)),C({id:`new_${Date.now()}`,coacheeId:"",items:[],taxRate:((h=c==null?void 0:c.company)==null?void 0:h.defaultTaxRate)||19,currency:((f=c==null?void 0:c.company)==null?void 0:f.defaultCurrency)||"EUR",invoiceNumber:N(),date:new Date().toISOString().split("T")[0],dueDate:j.toISOString().split("T")[0],status:R.DRAFT,title:"Coaching & Beratung"})}else{const N=n.find(d=>d.id.toString()===a);N?C(N):(r({title:"Fehler",description:"Rechnung nicht gefunden.",variant:"destructive"}),i("/invoices"))}},[a,A,s,n,c,r,i]);const[Z,z]=F.useState([]),$=v.find(o=>o.id===parseInt(t==null?void 0:t.coacheeId,10));F.useEffect(()=>{if(t!=null&&t.coacheeId){const o=l.filter(h=>h.coacheeId===parseInt(t.coacheeId,10)&&h.status==="completed"&&!h.billed&&!h.packageId);z(o)}else z([])},[t==null?void 0:t.coacheeId,l]);const J=o=>{const h=Z.find(d=>d.id===o);if(!h)return;const f=m.find(d=>d.name.toLowerCase().includes("standard"))||{id:null,price:120},N={id:`session-${h.id}`,description:`Coaching Session: "${h.topic}" am ${new Date(h.date).toLocaleDateString("de-DE")}`,quantity:1,price:f.price,rateId:f.id,isCustom:!f.id,sessionId:h.id};C(d=>({...d,items:[...d.items,N]})),z(d=>d.filter(j=>j.id!==o))},Q=(o,h)=>{const f=o.reduce((j,S)=>j+S.quantity*S.price,0),N=f*(parseFloat(h)/100),d=f+N;return{subtotal:f,taxAmount:N,total:d}},H=o=>{if(!t.coacheeId||t.items.length===0)return r({title:"Fehlende Angaben",description:"Bitte wähle einen Coachee aus und füge mindestens eine Position hinzu.",variant:"destructive"}),null;const{subtotal:h,taxAmount:f,total:N}=Q(t.items,t.taxRate),d={...t,status:o,subtotal:h,taxAmount:f,total:N,coacheeName:`${$.firstName} ${$.lastName}`,description:`${t.items.length} Position(en)`,items:t.items.map(({isCustom:j,sessionId:S,...p})=>p)};if(u(j=>{if(j.some(p=>p.id===d.id))return j.map(p=>p.id===d.id?d:p);{const p={...d,id:Date.now()};return[...j,p].sort((D,U)=>U.invoiceNumber.localeCompare(D.invoiceNumber))}}),o!==R.DRAFT){const j=t.items.filter(S=>S.sessionId).map(S=>S.sessionId);W(S=>S.map(p=>j.includes(p.id)?{...p,billed:!0}:p))}return d},X=()=>{H(R.DRAFT)&&(r({title:"Entwurf gespeichert!",description:"Die Rechnung wurde erfolgreich gespeichert."}),i("/invoices"))},ee=()=>{H(R.SENT)&&(r({title:"🚧 Senden nicht implementiert",description:"Die Rechnung wurde als 'Gesendet' gespeichert. Die Senden-Funktion kann im nächsten Prompt angefordert werden. 🚀"}),i("/invoices"))},se=()=>{const o=H(R.SENT);o&&(be(o,$,c.company),r({title:"PDF wird generiert",description:"Deine Rechnung wird heruntergeladen."}),i("/invoices"))};return s||!t?e.jsx("div",{className:"flex items-center justify-center h-screen bg-background",children:e.jsx(pe,{className:"h-10 w-10 animate-spin text-primary"})}):e.jsxs(e.Fragment,{children:[e.jsxs(xe,{children:[e.jsx("title",{children:A?"Neue Rechnung":`Rechnung ${t.invoiceNumber}`}),e.jsx("meta",{name:"description",content:"Erstelle und verwalte Rechnungen für deine Coachees."})]}),e.jsx(ge.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"min-h-screen bg-background text-foreground",children:e.jsxs("div",{className:"container mx-auto p-4 sm:p-6 lg:p-8",children:[e.jsx(Ee,{onClose:()=>i("/invoices"),isNew:A}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsx(we,{invoice:t,setInvoice:C,coachees:v}),e.jsx(Ie,{items:t.items,setItems:o=>C(h=>({...h,items:o})),serviceRates:m,currency:t.currency}),t.coacheeId&&e.jsx(Ce,{sessions:Z,onAddSession:J})]}),e.jsx(Ae,{items:t.items,taxRate:t.taxRate,currency:t.currency,onSaveDraft:X,onSaveAndDownload:se,onSaveAndSend:ee})]})]})})]})};export{Ge as default};
